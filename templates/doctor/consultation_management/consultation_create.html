{% extends '../base.html' %}
{% load crispy_forms_tags %}

{% block title %}Create New Consultation{% endblock %}

{% block content %}
<div class="px-4 mt-14 sm:ml-64">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Create New Consultation</h1>
        <p class="mt-1 text-sm text-gray-600">Schedule a new consultation for yourself</p>
    </div>

    <!-- Error Messages -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
            <div class="rounded-md p-4 mb-2 {% if message.tags == 'error' %}bg-red-50 text-red-700{% elif message.tags == 'success' %}bg-green-50 text-green-700{% else %}bg-blue-50 text-blue-700{% endif %}">
                <p class="text-sm">{{ message }}</p>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Form Card -->
<!-- Form Card -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-6">
<form method="post" id="consultation-form" novalidate>
      {% csrf_token %}

      <!-- Patient and Doctor Side-by-Side -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
              {{ form.patient|as_crispy_field }}
                    <!-- New Patient Link -->
                <div class="mt-2 flex items-center justify-between text-sm">
                  <span class="text-gray-500">Can't find patient?</span>
                  <a href="{% url 'patient_registration' %}" 
                      class="inline-flex items-center text-blue-600 hover:text-blue-800">
                      <i class="fas fa-user-plus mr-1"></i>
                      Register New Patient
                  </a>
              </div>
          </div>
          <div>
              {{ form.doctor|as_crispy_field }}
          </div>
      </div>
      <!-- Center and Duration Side-by-Side -->
      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
              <label for="id_center" class="block text-base font-medium text-gray-700">Clinic / Medical Center</label>
              <select id="id_center" name="center" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" disabled>
                  <option value="">Select a clinic</option>
              </select>
          </div>

          <div>
              <label for="id_duration_minutes" class="block text-base font-medium text-gray-700">Consultation Duration</label>
              <select id="id_duration_minutes" name="duration_minutes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm">
                  <option value="15" {% if form.duration_minutes.value == '15' %}selected{% endif %}>15 minutes</option>
                  <option value="30" {% if form.duration_minutes.value == '30' %}selected{% endif %}>30 minutes</option>
                  <option value="45" {% if form.duration_minutes.value == '45' %}selected{% endif %}>45 minutes</option>
              </select>
          </div>
      </div>

      <!-- Chief Complaint and Priority -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <div>
          <div class="col-span-1">
            {{ form.priority|as_crispy_field }}
          </div>
        </div>
            <!-- Consultation Type and Priority -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
          <div class="col-span-1">
            {{ form.consultation_type|as_crispy_field }}
          </div>
        </div>
      <div class="md:col-span-2">
        <label for="id_chief_complaint" class="block text-base font-medium text-gray-700">Chief Complaint</label>
        <textarea id="id_chief_complaint" name="chief_complaint" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm">{{ form.chief_complaint.value }}</textarea>
      </div>
      <!-- Calendar and Slot Info remains unchanged -->

      <div id="consultation-calendar" class="mt-6">
        <div class="calendar-header mb-2 flex items-center justify-between">
                    {% comment %} <button type="button" id="prev-month" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300"><</button> {% endcomment %}
          <div id="calendar-month-year" class="font-semibold"></div>
                    {% comment %} <button type="button" id="next-month" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">></button> {% endcomment %}
          </div>
                <!-- Added missing calendar container for flatpickr -->
          <div id="inline-calendar" class="mb-4"></div>
                <!-- Added missing timeslot container -->
          <div id="timeslot-container" class="mb-2 flex flex-wrap gap-2"></div>
                <!-- Added missing selected time info box -->
          <div id="selected-time-info" class="hidden text-sm text-indigo-600 font-medium"></div>
        </div>

            <!-- Selected Slot -->
        <input type="hidden" id="id_scheduled_datetime" name="scheduled_datetime">
        <input type="hidden" id="id_time_slot" name="time_slot">
      
        <div class="mt-8">
          <button type="submit" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all">
            Schedule Consultation
          </button>
        </div>
      </div>
</form>
</div>
      
      <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
      <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
      
      <script>
      document.addEventListener('DOMContentLoaded', function () {
        const doctorSelect = document.getElementById('id_doctor');
        const centerSelect = document.getElementById('id_center');
        const scheduledInput = document.getElementById('id_scheduled_datetime');
        const timeSlotInput = document.getElementById('id_time_slot');
        const timeslotContainer = document.getElementById('timeslot-container');
        const timeInfoBox = document.getElementById('selected-time-info');
      
        let availableDates = [];
        let timeslots = [];
      
        let fp = flatpickr("#inline-calendar", {
          inline: true,
          enableTime: false,
          dateFormat: "Y-m-d",
          minDate: "today",
          enable: [],
          onDayCreate: function (dObj, dStr, fp, dayElem) {
            const date = dayElem.dateObj.toISOString().slice(0, 10);
            if (availableDates.includes(date)) {
              dayElem.style.boxShadow = "0 0 0 2px #3b82f6";
              dayElem.style.borderRadius = "50%";
              dayElem.style.cursor = "pointer";
            }
          },
          onChange: function (selectedDates, dateStr) {
            if (dateStr && availableDates.includes(dateStr)) {
              fetchTimeslots(dateStr);
            } else {
              timeslotContainer.innerHTML = '';
              scheduledInput.value = '';
              timeSlotInput.value = '';
              timeInfoBox.classList.add('hidden');
              timeInfoBox.textContent = '';
            }
          }
        });
      
        doctorSelect.addEventListener('change', function () {
          const doctorId = this.value;
          centerSelect.innerHTML = '<option value="">Select a clinic</option>';
          centerSelect.disabled = true;
          scheduledInput.value = '';
          timeSlotInput.value = '';
          timeslotContainer.innerHTML = '';
          fp.set('enable', []);
          if (!doctorId) return;
      
          fetch(`/consultations/api/doctor-centers/?user_id=${doctorId}`, { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
              if (data.centers && data.centers.length > 0) {
                data.centers.forEach(center => {
                  const option = document.createElement('option');
                  option.value = center.id;
                  option.textContent = center.name;
                  centerSelect.appendChild(option);
                });
                centerSelect.disabled = false;
              }
            })
            .catch(error => console.error('Error fetching centers:', error));
        });
      
        centerSelect.addEventListener('change', function () {
          const doctorId = doctorSelect.value;
          const centerId = this.value;
          scheduledInput.value = '';
          timeSlotInput.value = '';
          timeslotContainer.innerHTML = '';
          fp.set('enable', []);
          if (!doctorId || !centerId) return;
      
          fetch(`/consultations/api/doctor-available-dates/?user_id=${doctorId}&center_id=${centerId}`, { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
              if (data.available_dates && data.available_dates.length > 0) {
                availableDates = data.available_dates;
                fp.set('enable', availableDates);
              } else {
                availableDates = [];
                fp.set('enable', []);
              }
            })
            .catch(error => console.error('Error fetching available dates:', error));
        });
      
        function fetchTimeslots(dateStr) {
          const doctorId = doctorSelect.value;
          const centerId = centerSelect.value;
          scheduledInput.value = '';
          timeSlotInput.value = '';
          timeslotContainer.innerHTML = '';
          timeInfoBox.classList.add('hidden');
          timeInfoBox.textContent = '';
      
          if (!doctorId || !centerId || !dateStr) return;
      
          fetch(`/consultations/api/doctor-timeslots/?user_id=${doctorId}&center_id=${centerId}&date=${dateStr}`, { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
              timeslots = data.timeslots || [];
              renderTimeslots(timeslots, dateStr);
            })
            .catch(error => console.error('Error fetching timeslots:', error));
        }
      
        function renderTimeslots(timeslots, dateStr) {
          timeslotContainer.innerHTML = '';
          if (timeslots.length === 0) {
            timeslotContainer.textContent = 'No available timeslots for selected date.';
            return;
          }
          timeslots.forEach(slot => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'px-3 py-2 rounded-md border border-gray-300 hover:bg-indigo-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm';
            btn.textContent = `${slot.start_time} - ${slot.end_time}`;
            btn.disabled = !slot.is_available;
            btn.addEventListener('click', () => {
              Array.from(timeslotContainer.children).forEach(child => child.classList.remove('bg-indigo-600', 'text-white'));
              btn.classList.add('bg-indigo-600', 'text-white');
              scheduledInput.value = `${dateStr} ${slot.start_time}`;
              timeSlotInput.value = slot.id;
              timeInfoBox.classList.remove('hidden');
              timeInfoBox.textContent = `Selected: ${dateStr} at ${slot.start_time}`;
            });
            timeslotContainer.appendChild(btn);
          });
        }
      });
      </script>
{% endblock %}
